{% extends 'base/base.html' %}
{% load static %}
{% block title %}Cart - ShopMate{% endblock %}
{% block content %}

<section class="cart-section">
  <h2>Your Shopping Cart</h2>

  {% if cart_items %}
  {% with cart=cart_items.0.cart_items %}
  <div class="cart-grid">
    {% for product_id, product in cart.items %}
    <div class="cart-card" data-product-id="{{ product_id }}">
      <img
        src="{{ MEDIA_URL }}{{ product.product_image }}"
        alt="{{ product.name }}"
        class="cart-image"
      />
      <div class="cart-details">
        <h3>{{ product.name }}</h3>
        <p>{{ product.description }}</p>
        <p>Price: ₹<span class="price">{{ product.price }}</span></p>
        <p class="subtotal">
          Subtotal: ₹<span class="line-total">{{ product.price|floatformat:2 }}</span>
        </p>

        <!-- Quantity Controls -->
        <div class="quantity-control">
          <button class="qty-btn btn-minus">−</button>
          <input
            type="text"
            value="{{ product.quantity }}"
            class="qty-input"
            readonly
          />
          <button class="qty-btn btn-plus">+</button>
        </div>

        <!-- Actions -->
        {% if userid %}
        <div class="cart-actions">
          <form
            method="post"
            action="{% url 'remove_from_cart' userid=userid productid=product_id %}"
          >
            {% csrf_token %}
            <button type="submit" class="btn btn-remove">Remove</button>
          </form>
        {% endif %}

        <!-- Buy Now Form -->
        <form
          method="post"
          action="{% url 'buy_single_product' userid=userid productid=product_id %}"
          class="buy-now-form"
        >
          {% csrf_token %}
          <input type="hidden" name="product_id" value="{{ product_id }}" />
          <input type="hidden" name="quantity" class="hidden-quantity" value="{{ product.quantity }}">
          <input type="hidden" name="price" value="{{ product.price }}">
          <button type="submit" class="btn btn-buy">Buy Now</button>
        </form>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Total Section -->
  <div class="cart-total">
    <h3>Total Amount: ₹<span id="total-amount">0</span></h3>
    <form method="post" action="{% url 'buy_all_products' userid=userid %}" id="buy-all-form">
      {% csrf_token %}
      <input type="hidden" name="user_id" value="{{ userid }}">
      <!-- Dynamic quantity inputs will be injected by JS -->
      <button type="submit" class="btn btn-buy-all">Buy All Products</button>
    </form>
  </div>
  {% endwith %}
  {% else %}
  <p class="empty-cart">Your cart is empty.</p>
  {% endif %}
</section>

<!-- JavaScript -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const minusButtons = document.querySelectorAll(".btn-minus");
    const plusButtons = document.querySelectorAll(".btn-plus");

    function updateTotals() {
      let total = 0;

      document.querySelectorAll(".cart-card").forEach((card) => {
        const price = parseFloat(card.querySelector(".price").textContent);
        const quantityInput = card.querySelector(".qty-input");
        const quantity = parseInt(quantityInput.value);
        const lineTotal = price * quantity;

        // Update line total
        card.querySelector(".line-total").textContent = lineTotal.toFixed(2);

        // Update hidden quantity input in Buy Now form
        const hiddenQty = card.querySelector(".hidden-quantity");
        if (hiddenQty) hiddenQty.value = quantity;

        total += lineTotal;
      });

      document.getElementById("total-amount").textContent = total.toFixed(2);
    }

    function changeQuantity(button, delta) {
      const card = button.closest(".cart-card");
      const qtyInput = card.querySelector(".qty-input");
      let currentQty = parseInt(qtyInput.value);
      const newQty = currentQty + delta;

      if (newQty >= 1) {
        qtyInput.value = newQty;
        updateTotals();
      }
    }

    minusButtons.forEach((btn) => {
      btn.addEventListener("click", () => changeQuantity(btn, -1));
    });

    plusButtons.forEach((btn) => {
      btn.addEventListener("click", () => changeQuantity(btn, +1));
    });

    // Inject product quantities into the Buy All form before submission
    document.getElementById("buy-all-form").addEventListener("submit", function () {
      // Clear previous injected inputs
      this.querySelectorAll(".dynamic-product-input").forEach(el => el.remove());

      // Add new ones based on current quantities
      document.querySelectorAll(".cart-card").forEach((card) => {
        const productId = card.dataset.productId;
        const quantity = card.querySelector(".qty-input").value;

        const input = document.createElement("input");
        input.type = "hidden";
        input.name = `quantities[${productId}]`;
        input.value = quantity;
        input.classList.add("dynamic-product-input");

        this.appendChild(input);
      });
    });

    // Initial total
    updateTotals();
  });
</script>

{% endblock %}

{% extends 'base/base.html' %}
{% block title %}Product - ShopMate{% endblock %}

{% block content %}
<!-- CATEGORY SECTION -->
<section class="category-section">
  <h2>Categories</h2>
  <div class="categories">
    <form method="get" action="" id="filter-form">
      <input type="hidden" name="category" id="category-input" value="{{ request.GET.category }}">

      <label for="filter">Sort by:</label>
      <select name="filter" id="filter" onchange="document.getElementById('filter-form').submit()">
        <option value="all" {% if request.GET.filter == 'all' %}selected{% endif %}>All</option>
        <option value="low_to_high" {% if request.GET.filter == 'low_to_high' %}selected{% endif %}>Price: Low to High</option>
        <option value="high_to_low" {% if request.GET.filter == 'high_to_low' %}selected{% endif %}>Price: High to Low</option>
      </select>

      <!-- Category Buttons -->
      <button type="button" class="category-btn {% if request.GET.category == 'all' %}active{% endif %}" onclick="setCategoryAndSubmit('all')">All</button>
      <button type="button" class="category-btn {% if request.GET.category == 'electronics' %}active{% endif %}" onclick="setCategoryAndSubmit('electronics')">Electronics</button>
      <button type="button" class="category-btn {% if request.GET.category == 'fashion' %}active{% endif %}" onclick="setCategoryAndSubmit('fashion')">Fashion</button>
      <button type="button" class="category-btn {% if request.GET.category == 'footwear' %}active{% endif %}" onclick="setCategoryAndSubmit('footwear')">Footwear</button>
      <button type="button" class="category-btn {% if request.GET.category == 'accessories' %}active{% endif %}" onclick="setCategoryAndSubmit('accessories')">Accessories</button>
      <button type="button" class="category-btn {% if request.GET.category == 'home_appliances' %}active{% endif %}" onclick="setCategoryAndSubmit('home_appliances')">Home Appliances</button>
    </form>

    {% if user.role == "admin" %}
    <div class="admin-controls">
      <button type="button" class="btn add-btn" onclick="openModal()">+ Add New Product</button>
    </div>
    {% endif %}
  </div>
</section>

<script>
  function setCategoryAndSubmit(category) {
    document.getElementById('category-input').value = category;
    document.getElementById('filter-form').submit();
  }
</script>

<!-- PRODUCTS -->
{% if products %}
<section class="products">
  <div class="product-grid">
    {% for product in products %}
    <div class="product-card">
      <img src="{{ product.product_image.url }}" alt="{{ product.name }}" />
      <h3>{{ product.name }}</h3>
      <p>₹{{ product.price }}</p>
      <p>{{ product.description }}</p>
      <p>Stock : {{ product.stock }}</p>
      
      {% if userid %}
      <form
        method="post"
        action="{% url 'add_to_cart' userid=userid productid=product.productid %}"
      >
        {% csrf_token %}
        <input type="hidden" name="productid" value="{{ product.productid }}" />
        {% if product.stock != 0 %}
        <button type="submit" class="btn small">Add to Cart</button>
        {% endif %}
        {% if product.stock == 0 %}
          <svg width="24" height="24" viewBox="0 0 64 64" fill="none">
            <path d="M8 8h6l4 24h28l4-16H18" stroke="#333" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="22" cy="52" r="3" fill="#333"/>
            <circle cx="46" cy="52" r="3" fill="#333"/>
            <circle cx="50" cy="14" r="8" fill="#e74c3c"/>
            <line x1="46" y1="10" x2="54" y2="18" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <line x1="54" y1="10" x2="46" y2="18" stroke="white" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <span style="font-family: 'Segoe UI', sans-serif; font-size: 14px;">Out of Stock</span>
        {% endif %}
      </form>
      {% endif %}

      {% if user.role == "admin" %}
      <form method="post" action="{% url 'delete_product' userid=userid productid=product.productid %}" onsubmit="return confirm('Are you sure you want to delete this product?');">
        {% csrf_token %}
        <button type="submit" class="btn delete-btn">Delete</button>
      </form>
      {% endif %}
    </div>
    {% endfor %}
  </div>
</section>
{% endif %}

<!-- Add Product Modal -->
<div id="productModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2>Add New Product</h2>
    <form method="post" enctype="multipart/form-data" action="{% url 'add_product' userid=userid %}">
      {% csrf_token %}

      <label for="name">Name:</label>
      <input type="text" name="name" required>

      <label for="product_image">Product Image:</label>
      <input type="file" name="product_image" accept="image/*" required>

      <label for="price">Price:</label>
      <input type="number" name="price" step="0.01" required>

      <label for="description">Description:</label>
      <textarea name="description" required></textarea>

      <label for="stock">Stock:</label>
      <input type="number" name="stock" required>

      <!-- ✅ New Category Dropdown -->
      <label for="category">Category:</label>
      <select name="category" required>
        <option value="" disabled selected>Select Category</option>
        <option value="electronics">Electronics</option>
        <option value="fashion">Fashion</option>
        <option value="home_appliances">Home Appliances</option>
        <option value="footwear">Footwear</option>
        <option value="accessories">Accessories</option>
      </select>

      <button type="submit" class="btn submit-btn">Add Product</button>
</form>

  </div>
</div>

<script>
  function openModal() {
    document.getElementById('productModal').style.display = 'block';
  }

  function closeModal() {
    document.getElementById('productModal').style.display = 'none';
  }

  window.onclick = function(event) {
    const modal = document.getElementById('productModal');
    if (event.target == modal) {
      modal.style.display = "none";
    }
  }
</script>

{% endblock %}
